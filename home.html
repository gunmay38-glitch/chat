<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mini WhatsApp Clone</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body { margin: 0; background: #ece5dd; }

.auth, .chat {
  max-width: 500px;
  margin: auto;
  height: 100vh;
  background: #fff;
  display: none;
  flex-direction: column;
}

.auth { padding: 20px; }

input, button {
  padding: 10px;
  margin: 8px 0;
  width: 100%;
  color: #000;
  background: #fff;
  border: 1px solid #ccc;
  font-size: 16px;
}

header {
  background: #075e54;
  color: white;
  padding: 12px;
  text-align: center;
  font-weight: bold;
}

.messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #e5ddd5;
}

.msg {
  margin: 6px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 75%;
}

.me { background: #dcf8c6; margin-left: auto; }
.other { background: #fff; }

.time {
  font-size: 10px;
  color: #555;
  text-align: right;
}

footer {
  display: flex;
  padding: 8px;
  border-top: 1px solid #ddd;
  gap: 6px;
  background: #f0f0f0;
}

footer input {
  flex: 1;
  border-radius: 20px;
  padding-left: 15px;
}

footer button {
  width: auto;
  border-radius: 20px;
  background: #075e54;
  color: white;
  border: none;
}
</style>
</head>
<body>

<!-- AUTH -->
<div class="auth" id="auth">
  <h2>Register / Login</h2>
  <input id="username" placeholder="Username" />
  <input id="password" type="password" placeholder="Password" />
  <button id="registerBtn">Register</button>
  <button id="loginBtn">Login</button>
</div>

<!-- CHAT -->
<div class="chat" id="chat">
  <header>Mini WhatsApp</header>
  <input id="chatUser" placeholder="Chat with username" />
  <div class="messages" id="messages"></div>
  <footer>
    <input id="messageInput" placeholder="Type a message" />
    <button id="sendBtn">Send</button>
  </footer>
</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAaXRb6M7siNeQI1OAy1W9DULuuDDX8CDg",
  authDomain: "chat-4b38b.firebaseapp.com",
  projectId: "chat-4b38b",
  storageBucket: "chat-4b38b.appspot.com",
  messagingSenderId: "656059272540",
  appId: "1:656059272540:web:0d5ec37ab2ca12c145c599"
};

firebase.initializeApp(firebaseConfig);

const authFB = firebase.auth();
const db = firebase.firestore();

/* DOM ELEMENTS (FIXED) */
const authDiv = document.getElementById("auth");
const chatDiv = document.getElementById("chat");
const messagesDiv = document.getElementById("messages");

const usernameInput = document.getElementById("username");
const passwordInput = document.getElementById("password");
const chatUserInput = document.getElementById("chatUser");
const messageInput = document.getElementById("messageInput");

const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const sendBtn = document.getElementById("sendBtn");

let currentUser = null;
let unsubscribe = null;

/* AUTH STATE */
authFB.onAuthStateChanged(user => {
  if (user) {
    currentUser = user.email.split("@")[0];
    authDiv.style.display = "none";
    chatDiv.style.display = "flex";
  } else {
    authDiv.style.display = "block";
    chatDiv.style.display = "none";
  }
});

/* REGISTER */
registerBtn.onclick = () => {
  if (!usernameInput.value || !passwordInput.value)
    return alert("Fill all fields");

  authFB.createUserWithEmailAndPassword(
    usernameInput.value + "@chat.com",
    passwordInput.value
  ).catch(e => alert(e.message));
};

/* LOGIN */
loginBtn.onclick = () => {
  authFB.signInWithEmailAndPassword(
    usernameInput.value + "@chat.com",
    passwordInput.value
  ).catch(e => alert(e.message));
};

/* SEND MESSAGE */
sendBtn.onclick = () => {
  if (!chatUserInput.value || !messageInput.value) return;

  db.collection("messages").add({
    from: currentUser,
    to: chatUserInput.value,
    text: messageInput.value,
    time: firebase.firestore.FieldValue.serverTimestamp(),
    seen: false
  });

  messageInput.value = "";
};

/* LOAD MESSAGE HISTORY (SAFE) */
chatUserInput.addEventListener("change", () => {
  if (unsubscribe) unsubscribe();

  const other = chatUserInput.value;
  if (!other) return;

  unsubscribe = db.collection("messages")
    .orderBy("time")
    .onSnapshot(snapshot => {
      messagesDiv.innerHTML = "";

      snapshot.forEach(doc => {
        const m = doc.data();
        const isChat =
          (m.from === currentUser && m.to === other) ||
          (m.from === other && m.to === currentUser);

        if (!isChat) return;

        const div = document.createElement("div");
        div.className = "msg " + (m.from === currentUser ? "me" : "other");

        div.innerHTML = `
          ${m.text}
          <div class="time">
            ${m.time ? m.time.toDate().toLocaleTimeString() : ""}
            ${m.from === currentUser ? (m.seen ? "âœ“âœ“" : "âœ“") : ""}
          </div>
        `;

        messagesDiv.appendChild(div);

        if (m.to === currentUser && !m.seen) {
          doc.ref.update({ seen: true });
        }
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
});
</script>
</body>
</html>
