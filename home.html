<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mini WhatsApp</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  background: #ece5dd;
}

/* SCREENS */
.screen {
  display: none;
  flex-direction: column;
  height: 100vh;
  max-width: 500px;
  margin: auto;
  background: #fff;
}

.screen.active {
  display: flex;
}

/* AUTH */
#auth {
  padding: 20px;
}

input, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
  background: #fff;
  color: #000;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  background: #075e54;
  color: #fff;
  border: none;
}

/* HEADER */
header {
  background: #075e54;
  color: white;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* CHAT LIST */
#chats {
  flex: 1;
  overflow-y: auto;
}

.chat-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.chat-item:hover {
  background: #f5f5f5;
}

.chat-name {
  font-weight: bold;
}

.chat-last {
  font-size: 13px;
  color: #555;
}

/* CHAT SCREEN */
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  background: #e5ddd5;
}

.msg {
  max-width: 75%;
  padding: 8px 12px;
  margin: 5px 0;
  border-radius: 10px;
  word-wrap: break-word;
}

.me {
  background: #dcf8c6;
  margin-left: auto;
}

.them {
  background: #fff;
}

/* FOOTER — DRAFT FIX IS HERE */
footer {
  display: flex;
  padding: 10px;
  background: #f0f0f0;
}

footer input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
  background: #ffffff;
  color: #000000;
  font-size: 16px;
  z-index: 10;
}

footer button {
  margin-left: 8px;
  padding: 10px 16px;
  border-radius: 50%;
  background: #25d366;
  color: white;
  border: none;
  cursor: pointer;
}

/* MENU */
#menu {
  position: absolute;
  top: 55px;
  right: 10px;
  background: #fff;
  border: 1px solid #ccc;
  display: none;
  z-index: 1000;
}

#menu div {
  padding: 10px;
  cursor: pointer;
}

#menu div:hover {
  background: #eee;
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth" class="screen active">
  <h2>Login / Register</h2>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
</div>

<!-- CHAT LIST -->
<div id="chatList" class="screen">
  <header>
    Chats
    <span onclick="newChat()" style="cursor:pointer">➕</span>
  </header>
  <div id="chats"></div>
</div>

<!-- CHAT SCREEN -->
<div id="chatScreen" class="screen">
  <header>
    <span onclick="goBack()" style="cursor:pointer">⬅ <span id="chatWith"></span></span>
    <span onclick="toggleMenu()" style="cursor:pointer">⋮</span>
  </header>

  <div id="messages"></div>

  <footer>
    <input id="msgInput" placeholder="Type a message…" />
    <button onclick="sendMsg()">➤</button>
  </footer>

  <div id="menu">
    <div onclick="clearChat()">Clear chat</div>
    <div onclick="deleteChat()" style="color:red">Delete chat</div>
  </div>
</div>

<script>
/* FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyAaXRb6M7siNeQI1OAy1W9DULuuDDX8CDg",
  authDomain: "chat-4b38b.firebaseapp.com",
  projectId: "chat-4b38b"
});

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = "";
let currentChat = "";
let unsubscribe = null;

/* AUTH STATE */
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user.email.split("@")[0];
    show("chatList");
    loadChats();
  }
});

/* AUTH */
function register() {
  auth.createUserWithEmailAndPassword(
    username.value + "@chat.com",
    password.value
  ).catch(e => alert(e.message));
}

function login() {
  auth.signInWithEmailAndPassword(
    username.value + "@chat.com",
    password.value
  ).catch(e => alert(e.message));
}

/* SCREEN SWITCH */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* LOAD CHAT LIST */
function loadChats() {
  db.collection("messages").orderBy("time")
    .onSnapshot(snap => {
      chats.innerHTML = "";
      const users = {};
      snap.forEach(d => {
        const m = d.data();
        if (m.from === currentUser || m.to === currentUser) {
          const other = m.from === currentUser ? m.to : m.from;
          users[other] = m;
        }
      });
      Object.keys(users).forEach(u => {
        const div = document.createElement("div");
        div.className = "chat-item";
        div.innerHTML = `<div class="chat-name">${u}</div>
                         <div class="chat-last">${users[u].text}</div>`;
        div.onclick = () => openChat(u);
        chats.appendChild(div);
      });
    });
}

/* OPEN CHAT */
function openChat(user) {
  currentChat = user;
  chatWith.innerText = user;
  show("chatScreen");
  loadMessages();
}

/* LOAD MESSAGES */
function loadMessages() {
  if (unsubscribe) unsubscribe();
  unsubscribe = db.collection("messages").orderBy("time")
    .onSnapshot(snap => {
      messages.innerHTML = "";
      snap.forEach(d => {
        const m = d.data();
        if (
          (m.from === currentUser && m.to === currentChat) ||
          (m.from === currentChat && m.to === currentUser)
        ) {
          const div = document.createElement("div");
          div.className = "msg " + (m.from === currentUser ? "me" : "them");
          div.textContent = m.text;
          messages.appendChild(div);
        }
      });
      messages.scrollTop = messages.scrollHeight;
    });
}

/* SEND MESSAGE */
function sendMsg() {
  const text = msgInput.value.trim();
  if (!text) return;
  db.collection("messages").add({
    from: currentUser,
    to: currentChat,
    text,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value = "";
}

/* MENU */
function toggleMenu() {
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function clearChat() {
  toggleMenu();
  db.collection("messages")
    .where("from", "in", [currentUser, currentChat])
    .where("to", "in", [currentUser, currentChat])
    .get()
    .then(snap => snap.forEach(d => d.ref.delete()));
}

function deleteChat() {
  toggleMenu();
  goBack();
}

/* NAV */
function goBack() {
  show("chatList");
}

function newChat() {
  const u = prompt("Enter username");
  if (u) openChat(u);
}
</script>
</body>
</html>
